# Services Documentation

## Overview
Папка содержит сервисы, реализующие бизнес-логику приложения. Сервисы обрабатывают операции, связанные с пользователями, платежами, реферальной системой и администрированием.

## Files Structure

### __init__.py

Пустой файл, необходим для корректной работы пакета.

### admin.py
Сервис для административных задач.

#### Классы:
- `AdminService`
  - **Описание**: Сервис, предоставляющий функциональность для управления и администрирования бота.
  - **Методы**:
    - `get_stats() -> Dict[str, Any]`
      - **Описание**: Получение общей статистики бота, включая количество пользователей, активных и завершенных новелл, статистику рефералов и платежей.
      - **Параметры**: Нет.
      - **Возвращает**: Словарь с ключами:
        - `total_users`: Общее количество пользователей.
        - `active_novels`: Количество активных новелл.
        - `completed_novels`: Количество завершенных новелл.
        - `total_referrals`: Общее количество рефералов.
        - `active_referrers`: Количество активных рефереров.
        - `total_payments`: Общее количество платежей.
        - `total_amount`: Общая сумма платежей.
    
    - `get_user_details(user_id: int) -> Dict[str, Any]`
      - **Описание**: Получение детальной информации о пользователе.
      - **Параметры**:
        - `user_id` - Идентификатор пользователя.
      - **Возвращает**: Словарь с деталями пользователя, включая состояние новеллы, реферальную ссылку, список рефералов, награды и платежи.
    
    - `clear_database() -> None`
      - **Описание**: Очистка всей базы данных.
      - **Параметры**: Нет.
      - **Возвращает**: Нет.

### novel.py
Сервис для управления новеллами пользователей.

#### Классы:
- `NovelService`
  - **Описание**: Сервис, отвечающий за состояние новелл пользователей и их взаимодействие.
  - **Методы**:
    - `get_novel_state(user_id: int) -> Optional[NovelState]`
      - **Описание**: Получение текущего состояния новеллы пользователя.
      - **Параметры**:
        - `user_id` - Идентификатор пользователя.
      - **Возвращает**: Объект `NovelState` или `None`, если новелла не найдена.
    
    - `create_novel_state(user_id: int) -> Optional[NovelState]`
      - **Описание**: Создание нового состояния новеллы для пользователя.
      - **Параметры**:
        - `user_id` - Идентификатор пользователя.
      - **Возвращает**: Объект `NovelState` или `None`, если создание не удалось.
    
    - `process_message(message: Message, novel_state: NovelState, initial_message: bool = False) -> None`
      - **Описание**: Обработка сообщения пользователя и взаимодействие с OpenAI.
      - **Параметры**:
        - `message` - Сообщение от пользователя.
        - `novel_state` - Текущее состояние новеллы.
        - `initial_message` - Флаг, указывающий, является ли сообщение начальным.
      - **Возвращает**: Нет.
    
    - `end_story(novel_state: NovelState, message: Message, silent: bool = False) -> None`
      - **Описание**: Завершение новеллы и очистка связанных данных.
      - **Параметры**:
        - `novel_state` - Текущее состояние новеллы.
        - `message` - Сообщение для отправки пользователю.
        - `silent` - Флаг, указывающий, следует ли отправлять уведомление пользователю.
      - **Возвращает**: Нет.
    
    - `save_message(novel_state: NovelState, content: str, is_user: bool = False) -> NovelMessage`
      - **Описание**: Сохранение сообщения в базу данных.
      - **Параметры**:
        - `novel_state` - Текущее состояние новеллы.
        - `content` - Текст сообщения.
        - `is_user` - Флаг, указывающий, является ли сообщение от пользователя.
      - **Возвращает**: Объект `NovelMessage`.
    
    - `get_last_assistant_message(novel_state: NovelState) -> Optional[str]`
      - **Описание**: Получение последнего сообщения ассистента.
      - **Параметры**:
        - `novel_state` - Текущее состояние новеллы.
      - **Возвращает**: Текст последнего сообщения ассистента или `None`, если сообщений нет.
  
  - **Приватные методы:**
    - `_handle_initial_message(novel_state: NovelState) -> None`
      - **Описание**: Обработка начального сообщения новеллы.
      - **Параметры**:
        - `novel_state` - Текущее состояние новеллы.
      - **Возвращает**: Нет.
    
    - `_handle_regular_message(message: Message, novel_state: NovelState, text: str) -> None`
      - **Описание**: Обработка обычного сообщения пользователя.
      - **Параметры**:
        - `message` - Сообщение от пользователя.
        - `novel_state` - Текущее состояние новеллы.
        - `text` - Текст сообщения.
      - **Возвращает**: Нет.
    
    - `_process_assistant_response(novel_state: NovelState) -> str`
      - **Описание**: Обработка ответа ассистента.
      - **Параметры**:
        - `novel_state` - Текущее состояние новеллы.
      - **Возвращает**: Текст ответа ассистента.
    
    - `_save_and_send_response(message: Message, novel_state: NovelState, assistant_message: str) -> None`
      - **Описание**: Сохранение и отправка ответа ассистента.
      - **Параметры**:
        - `message` - Сообщение от пользователя.
        - `novel_state` - Текущее состояние новеллы.
        - `assistant_message` - Сообщение от ассистента.
      - **Возвращает**: Нет.

### referral.py
Сервис для управления реферальной системой.

#### Классы:
- `ReferralService`
  - **Описание**: Сервис, обеспечивающий функциональность реферальной системы.
  - **Методы**:
    - `create_referral_link(user_id: int) -> ReferralLink`
      - **Описание**: Создание новой реферальной ссылки для пользователя.
      - **Параметры**:
        - `user_id` - Идентификатор пользователя.
      - **Возвращает**: Объект `ReferralLink`.
    
    - `process_referral(referrer_id: int, referred_id: int) -> Optional[PendingReferral]`
      - **Описание**: Обработка нового реферала.
      - **Параметры**:
        - `referrer_id` - Идентификатор реферера.
        - `referred_id` - Идентификатор приглашенного.
      - **Возвращает**: Объект `PendingReferral` или `None`, если реферал уже существует.
    
    - `get_user_rewards(user_id: int) -> List[ReferralReward]`
      - **Описание**: Получение списка наград пользователя за рефералов.
      - **Параметры**:
        - `user_id` - Идентификатор пользователя.
      - **Возвращает**: Список объектов `ReferralReward`.

### payment.py
Сервис для обработки платежей пользователей.

#### Классы:
- `PaymentService`
  - **Описание**: Сервис, отвечающий за обработку платежей и управление транзакциями.
  - **Методы**:
    - `process_payment(user_id: int, payload: str, amount: int, novel_service: NovelService) -> None`
      - **Описание**: Обработка успешного платежа.
      - **Параметры**:
        - `user_id` - Идентификатор пользователя.
        - `payload` - Дополнительные данные платежа.
        - `amount` - Сумма платежа.
        - `novel_service` - Экземпляр `NovelService` для обновления состояния новеллы.
      - **Возвращает**: Нет.
    
    - `get_payment_history(user_id: int) -> List[Payment]`
      - **Описание**: Получение истории платежей пользователя.
      - **Параметры**:
        - `user_id` - Идентификатор пользователя.
      - **Возвращает**: Список объектов `Payment`.
    
    - `count_all_payments() -> int`
      - **Описание**: Подсчет общего количества платежей.
      - **Параметры**: Нет.
      - **Возвращает**: Общее количество платежей.
    
    - `get_total_payment_amount() -> int`
      - **Описание**: Получение общей суммы всех платежей.
      - **Параметры**: Нет.
      - **Возвращает**: Общая сумма платежей.

## Integration Points
- `repositories/` - Используются для доступа к данным.
- `unit_of_work/` - Управление транзакциями.
- `handlers/` - Взаимодействие с обработчиками сообщений.
- `di/` - Внедрение зависимостей.

## Dependencies
- `sqlalchemy` - ORM для работы с базой данных.
- `structlog` - Логирование.
- `typing` - Типизация.
- `repositories/` - Репозитории данных.
- `unit_of_work/` - Паттерн Unit of Work.

## Features
- Разделение бизнес-логики по сервисам.
- Асинхронная обработка.
- Взаимодействие с базой данных через репозитории.
- Управление транзакциями через Unit of Work.
- Логирование всех операций.

## Error Handling
- Логирование через `structlog`.
- Обработка исключений внутри сервисов.
- Возврат или поднятие исключений для корректной обработки ошибок на уровне обработчиков.

